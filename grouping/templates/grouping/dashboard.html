<!DOCTYPE html>
<html>
<head>
    <title>Intelligent Group Formatter</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; margin: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 20px; }
        .main-wrapper { display: flex; gap: 20px; padding: 0 20px; align-items: flex-start; }
        .sidebar { width: 320px; flex-shrink: 0; display: flex; flex-direction: column; gap: 20px; }
        .content { flex: 1; min-width: 0; } 
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .group-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .group-card { flex: 1; min-width: 300px; background: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #bbdefb; }
        .student-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .student-item { background: white; padding: 8px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #2196f3; }
        .badge { background: #2196f3; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }
        
        /* ALERT BADGES */
        .status-ok { font-size: 0.8em; background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 4px; border: 1px solid #c8e6c9; }
        .status-bad { font-size: 0.8em; background: #ffebee; color: #c62828; padding: 2px 8px; border-radius: 4px; border: 1px solid #ffcdd2; font-weight: bold;}
        
        /* SUGGESTION BOX */
        .suggestion-box { margin-top: 5px; font-size: 0.75em; color: #856404; background-color: #fff3cd; border: 1px solid #ffeeba; padding: 4px; border-radius: 4px; display: inline-block;}

        button { border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 8px 12px; }
        .btn-add { background: #ff9800; color: white; width: 100%; margin-top: 10px; }
        .btn-gen { background: #4caf50; color: white; width: 100%; margin-top: 10px; }
        .btn-del { background: #f44336; color: white; font-size: 12px; padding: 5px 10px; }
        .btn-reset { background: #f44336; color: white; padding: 10px 15px; }
        input[type="text"], input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        .weight-row { display: flex; gap: 10px; margin-top: 5px; }
        .weight-col { flex: 1; text-align: center; }
        .weight-col label { font-size: 0.7em; color: #666; display: block;}
        .weight-col input { width: 100%; padding: 5px; text-align: center; box-sizing: border-box;}
    </style>
</head>
<body>

    <div class="header">
        <h1 style="margin:0; color:#333;">Intelligent Group Formatter</h1>
        <form action="{% url 'clear_data' %}" method="POST" onsubmit="return confirm('WARNING: This will delete ALL students. Continue?');">
            {% csrf_token %}
            <button type="submit" class="btn-reset">‚ö†Ô∏è Reset All</button>
        </form>
    </div>

    <div class="main-wrapper">
        <div class="sidebar">
            <div class="card" style="border-left: 5px solid #ff9800;">
                <h3 style="margin-top:0;">Add Student</h3>
                <form action="{% url 'add_student' %}" method="POST">
                    {% csrf_token %}
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div><label style="font-size:0.8em;">Name</label><br>{{ form.name }}</div>
                        <div style="display:flex; gap:5px;">
                            <div style="flex:1;"><label style="font-size:0.8em;">Code</label><br>{{ form.coding }}</div>
                            <div style="flex:1;"><label style="font-size:0.8em;">Design</label><br>{{ form.design }}</div>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <div style="flex:1;"><label style="font-size:0.8em;">Write</label><br>{{ form.writing }}</div>
                            <div style="flex:1;"><label style="font-size:0.8em;">Speak</label><br>{{ form.presenting }}</div>
                        </div>
                    </div>
                    <button type="submit" class="btn-add">+ Add to Roster</button>
                </form>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0;">Class Roster</h3>
                    <span style="font-size:0.8em; color:#666;">Total: {{ all_students|length }}</span>
                </div>
                <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
                <form action="{% url 'delete_students' %}" method="POST">
                    {% csrf_token %}
                    <div style="max-height: 400px; overflow-y: auto; margin-bottom: 10px;">
                        {% for s in all_students %}
                        <div class="student-row">
                            <div><input type="checkbox" name="student_ids" value="{{ s.id }}"> <strong>{{ s.name }}</strong></div>
                            {% if s.assigned_group %}<span style="font-size:0.7em; background:#e3f2fd; padding:2px 5px; border-radius:3px;">{{ s.assigned_group.name }}</span>{% else %}<span style="font-size:0.7em; color:#999;">Unassigned</span>{% endif %}
                        </div>
                        {% empty %}
                        <p style="color:#999; text-align:center;">No students added yet.</p>
                        {% endfor %}
                    </div>
                    {% if all_students %}<button type="submit" class="btn-del" style="width:100%;">Delete Selected</button>{% endif %}
                </form>
            </div>
        </div>

        <div class="content">
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-top:0;">Generate Groups</h3>
                <form action="{% url 'generate_groups' %}" method="POST">
                    {% csrf_token %}
                    <div style="display:flex; align-items:center; gap:20px; margin-bottom: 15px;">
                        <label><strong>Number of Groups (K):</strong></label>
                        <input type="number" name="group_count" value="2" min="1" max="10" style="width:60px;">
                    </div>
                    <div style="background: #f9f9f9; padding: 10px; border-radius: 5px;">
                        <label style="font-size: 0.9em; font-weight: bold;">Skill Priority Weights (Multipliers):</label>
                        <div class="weight-row">
                            <div class="weight-col"><label>Code</label><input type="number" name="weight_c" value="1" min="1" max="5"></div>
                            <div class="weight-col"><label>Design</label><input type="number" name="weight_d" value="1" min="1" max="5"></div>
                            <div class="weight-col"><label>Write</label><input type="number" name="weight_w" value="1" min="1" max="5"></div>
                            <div class="weight-col"><label>Speak</label><input type="number" name="weight_p" value="1" min="1" max="5"></div>
                        </div>
                    </div>
                    <button type="submit" class="btn-gen">Auto-Format Groups</button>
                </form>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

            <div class="group-container">
                {% for item in group_data %}
                <div class="group-card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0;">{{ item.group.name }}</h3>
                            <div style="margin-top: 5px; display:flex; flex-direction:column; align-items:flex-start;">
                                {% if item.is_unbalanced %}
                                    <span class="status-bad">‚ö†Ô∏è Unbalanced (Dev: ¬±{{ item.compatibility_score|floatformat:1 }})</span>
                                    <span class="suggestion-box">üí° {{ item.suggestion }}</span>
                                {% else %}
                                    <span class="status-ok">‚úî Balanced (Dev: ¬±{{ item.compatibility_score|floatformat:1 }})</span>
                                {% endif %}
                            </div>
                        </div>
                        <div style="width: 140px; height: 140px;">
                            <canvas id="chart-{{ item.group.id }}" data-skills="{{ item.skill_values }}"></canvas>
                        </div>
                    </div>
                    
                    <hr style="border: 0; border-top: 1px solid #bbdefb; margin: 10px 0;">

                    {% for student in item.group.students.all %}
                    <div class="student-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>{{ student.name }}</span>
                            <span class="badge">{{ student.coding|add:student.design|add:student.writing|add:student.presenting }} pts</span>
                        </div>
                        <form action="{% url 'move_student' student.id %}" method="POST" style="margin-top: 5px; display: flex; gap: 5px;">
                            {% csrf_token %}
                            <select name="new_group_id" style="font-size: 0.8em; padding: 2px; width:100%;">
                                <option value="" disabled selected>Move...</option>
                                {% for g in group_data %}
                                    {% if g.group.id != item.group.id %}
                                        <option value="{{ g.group.id }}">{{ g.group.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <button type="submit" style="font-size: 0.7em; padding: 2px 5px; background: #2196f3; color: white;">Go</button>
                        </form>
                    </div>
                    {% empty %}
                    <p style="color:#666; font-style:italic;">Empty Group</p>
                    {% endfor %}

                    <script>
                        (function() {
                            var ctx = document.getElementById('chart-{{ item.group.id }}');
                            var skillsData = JSON.parse(ctx.getAttribute('data-skills'));
                            new Chart(ctx, {
                                type: 'radar',
                                data: {
                                    labels: ['Code', 'Design', 'Write', 'Speak'],
                                    datasets: [{
                                        data: skillsData, fill: true, backgroundColor: 'rgba(33, 150, 243, 0.2)', borderColor: 'rgb(33, 150, 243)', pointRadius: 2,
                                    }]
                                },
                                options: {
                                    scales: { r: { suggestedMin: 0, suggestedMax: 20, ticks: { display: false } } }, plugins: { legend: { display: false } }
                                }
                            });
                        })();
                    </script>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</body>
</html>