<!DOCTYPE html>
<html>
<head>
    <title>Intelligent Group Formatter</title>
    <style>
        /* DARK THEME CORE */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px 20px 100px 20px; 
            background-color: #121212; 
            color: #e0e0e0; 
            margin: 0; 
        }
        
        /* HEADERS */
        h1, h2, h3, h4 { color: #ffffff; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 20px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        
        /* LAYOUT */
        .main-wrapper { display: flex; gap: 20px; padding: 0 20px; align-items: flex-start; }
        .sidebar { width: 340px; flex-shrink: 0; display: flex; flex-direction: column; gap: 20px; } 
        .content { flex: 1; min-width: 0; } 
        
        /* DARK CARDS */
        .card { background: #1e1e1e; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #333; }
        
        /* GROUP CARDS */
        .group-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .group-card { 
            flex: 1; min-width: 300px; 
            background: #252525; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid #ff9800; 
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        /* STUDENT LIST ITEMS */
        .student-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #333; }
        .student-item { 
            background: #333; 
            padding: 10px; 
            margin: 8px 0; 
            border-radius: 6px; 
            border-left: 4px solid #ff9800; 
        }

        /* BADGES */
        .badge { background: #ff9800; color: #000; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: bold; }
        
        /* SKILL PILLS */
        .skill-pill { font-size: 0.7em; color: #aaa; margin-left: 3px; }
        .skill-val { color: #ff9800; font-weight: bold; }

        /* ALERTS */
        .status-ok { font-size: 0.8em; background: #1b5e20; color: #a5d6a7; padding: 3px 10px; border-radius: 4px; border: 1px solid #2e7d32; }
        /* Removed .status-bad and .suggestion-box styles as they are no longer needed */

        /* INPUTS */
        input[type="text"], input[type="number"], select { 
            padding: 10px; 
            border: 1px solid #444; 
            border-radius: 4px; 
            background: #2d2d2d; 
            color: white; 
            width: 100%; 
            box-sizing: border-box;
        }
        input:focus { outline: none; border-color: #ff9800; }

        /* BUTTONS */
        button { border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 10px 15px; font-weight: bold; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }

        .btn-add { background: #ff9800; color: #000; width: 100%; margin-top: 10px; font-size: 16px;} 
        .btn-gen { background: #ff9800; color: #000; width: 100%; margin-top: 10px; font-size: 16px;} 
        
        .btn-del { background: #cf6679; color: black; font-size: 12px; padding: 5px 10px; }
        .btn-reset { background: #cf6679; color: black; padding: 8px 15px; }
        .btn-logout { background: #333; color: white; border: 1px solid #555; padding: 8px 15px; }
        .btn-go { background: #ff9800; color: black; padding: 5px 10px; font-size: 0.8em; }

        /* FLOATING BACK BUTTON */
        .btn-back { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            background: #ff9800; 
            color: #000; 
            padding: 15px 25px; 
            text-decoration: none; 
            border-radius: 50px; 
            font-size: 14px; 
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4); 
            z-index: 1000; 
            transition: transform 0.2s;
        }
        .btn-back:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(255, 152, 0, 0.6); }

        .weight-row { display: flex; gap: 10px; margin-top: 5px; }
        .weight-col { flex: 1; text-align: center; }
        .weight-col label { font-size: 0.7em; color: #aaa; display: block;}
    </style>
</head>
<body>

    <div class="header">
        <h1 style="margin:0;">
            <span style="font-weight:normal; font-size:0.6em; color:#ff9800; text-transform: uppercase; letter-spacing: 2px;">{{ section.name }} / </span>
            <br>Intelligent Group Formatter
        </h1>
        
        <div style="display: flex; gap: 15px; align-items: center;">
            {% if user.is_authenticated %}
                <span style="font-size: 0.9em; color: #aaa;">Teacher: <strong style="color: #ff9800;">{{ user.first_name }} {{ user.last_name }}</strong></span>
                <form action="{% url 'logout' %}" method="POST" style="margin:0;">
                    {% csrf_token %}
                    <button type="submit" class="btn-logout">Logout</button>
                </form>
            {% else %}
                <a href="{% url 'login' %}" style="text-decoration: none; background: #ff9800; color: black; padding: 8px 15px; border-radius: 4px;">Login</a>
            {% endif %}

            <form action="{% url 'clear_data' section.id %}" method="POST" onsubmit="return confirm('WARNING: This will delete ALL students. Continue?');" style="margin:0;">
                {% csrf_token %}
                <button type="submit" class="btn-reset">‚ö†Ô∏è Reset</button>
            </form>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="sidebar">
            <div class="card" style="border-left: 5px solid #ff9800;">
                <h3 style="margin-top:0; color: #ff9800;">Add Student</h3>
                <form action="{% url 'add_student' section.id %}" method="POST">
                    {% csrf_token %}
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div><label style="font-size:0.8em; color:#aaa;">Name</label><br>{{ form.name }}</div>
                        <div style="display:flex; gap:5px;">
                            <div style="flex:1;"><label style="font-size:0.8em; color:#aaa;">Code</label><br>{{ form.coding }}</div>
                            <div style="flex:1;"><label style="font-size:0.8em; color:#aaa;">Design</label><br>{{ form.design }}</div>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <div style="flex:1;"><label style="font-size:0.8em; color:#aaa;">Write</label><br>{{ form.writing }}</div>
                            <div style="flex:1;"><label style="font-size:0.8em; color:#aaa;">Speak</label><br>{{ form.presenting }}</div>
                        </div>
                    </div>
                    <button type="submit" class="btn-add">+ Add to Roster</button>
                </form>
            </div>

            <div class="card" style="padding: 15px; border: 1px solid #444;">
                <h4 style="margin-top:0; color: #ff9800; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; font-size: 1em;">
                    üìù Skill Assessment Rubric
                </h4>
                <ul style="padding-left: 20px; margin: 0; font-size: 0.8em; color: #aaa; line-height: 1.5;">
                    <li><strong style="color:#ff9800;">1 - Beginner:</strong> Little to no prior experience.</li>
                    <li><strong style="color:#ff9800;">2 - Novice:</strong> Basic knowledge, needs help.</li>
                    <li><strong style="color:#ff9800;">3 - Competent:</strong> Can work independently.</li>
                    <li><strong style="color:#ff9800;">4 - Proficient:</strong> Strong skill, problem solver.</li>
                    <li><strong style="color:#ff9800;">5 - Expert:</strong> Mastery level, can lead/teach.</li>
                </ul>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0;">Class Roster</h3>
                    <span style="font-size:0.8em; color:#aaa;">Total: {{ all_students|length }}</span>
                </div>
                <hr style="border:0; border-top:1px solid #333; margin:10px 0;">
                <form action="{% url 'delete_students' section.id %}" method="POST">
                    {% csrf_token %}
                    <div style="max-height: 400px; overflow-y: auto; margin-bottom: 10px; padding-right: 5px;">
                        {% for s in all_students %}
                        <div class="student-row">
                            <div style="display:flex; flex-direction: column;">
                                <div style="display:flex; align-items:center; gap: 8px;">
                                    <input type="checkbox" name="student_ids" value="{{ s.id }}" style="width: auto;"> 
                                    <strong>{{ s.name }}</strong>
                                </div>
                                <div style="margin-left: 25px; margin-top: 2px;">
                                    <span class="skill-pill">C:<span class="skill-val">{{ s.coding }}</span></span>
                                    <span class="skill-pill">D:<span class="skill-val">{{ s.design }}</span></span>
                                    <span class="skill-pill">W:<span class="skill-val">{{ s.writing }}</span></span>
                                    <span class="skill-pill">S:<span class="skill-val">{{ s.presenting }}</span></span>
                                </div>
                            </div>
                            
                            <div>
                                {% if s.assigned_group %}
                                    <span style="font-size:0.7em; background:#333; color: #ff9800; padding:2px 5px; border-radius:3px; border: 1px solid #555;">{{ s.assigned_group.name }}</span>
                                {% else %}
                                    <span style="font-size:0.7em; color:#666;">Unassigned</span>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <p style="color:#666; text-align:center; font-style:italic;">No students added yet.</p>
                        {% endfor %}
                    </div>
                    {% if all_students %}<button type="submit" class="btn-del" style="width:100%;">Delete Selected</button>{% endif %}
                </form>
            </div>
        </div>

        <div class="content">
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-top:0; color: #ff9800;">Generate Groups</h3>
                <form action="{% url 'generate_groups' section.id %}" method="POST">
                    {% csrf_token %}
                    <div style="display:flex; align-items:center; gap:20px; margin-bottom: 15px;">
                        <label><strong>Number of Groups (K):</strong></label>
                        <input type="number" name="group_count" value="2" min="1" max="10" style="width:80px; background:#333; border:1px solid #555; color: white;">
                    </div>
                    <div style="background: #252525; padding: 15px; border-radius: 8px; border: 1px solid #333;">
                        <label style="font-size: 0.9em; font-weight: bold; color: #aaa;">Skill Priority Weights (Multipliers):</label>
                        <div class="weight-row">
                            <div class="weight-col"><label>Code</label><input type="number" name="weight_c" value="1" min="1" max="5"></div>
                            <div class="weight-col"><label>Design</label><input type="number" name="weight_d" value="1" min="1" max="5"></div>
                            <div class="weight-col"><label>Write</label><input type="number" name="weight_w" value="1" min="1" max="5"></div>
                            <div class="weight-col"><label>Speak</label><input type="number" name="weight_p" value="1" min="1" max="5"></div>
                        </div>
                    </div>
                    <button type="submit" class="btn-gen">Auto-Format Groups</button>
                </form>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

            <div class="group-container">
                {% for item in group_data %}
                <div class="group-card">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 style="margin: 0; color: #ff9800;">{{ item.group.name }}</h3>
                            <div style="margin-top: 5px; display:flex; flex-direction:column; align-items:flex-start;">
                                <span class="status-ok">‚úî Balanced</span>
                            </div>
                        </div>
                        <div style="width: 140px; height: 140px;">
                            <canvas id="chart-{{ item.group.id }}" data-skills="{{ item.skill_values }}"></canvas>
                        </div>
                    </div>
                    
                    <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0;">

                    <div style="flex: 1;">
                        {% for student in item.group.students.all %}
                        <div class="student-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #e0e0e0;">{{ student.name }}</span>
                                <span style="font-size:0.75em; color:#aaa;">
                                    C:<b style="color:#ff9800">{{ student.coding }}</b> 
                                    D:<b style="color:#ff9800">{{ student.design }}</b> 
                                    W:<b style="color:#ff9800">{{ student.writing }}</b> 
                                    S:<b style="color:#ff9800">{{ student.presenting }}</b>
                                </span>
                            </div>
                            <form action="{% url 'move_student' section.id student.id %}" method="POST" style="margin-top: 5px; display: flex; gap: 5px;">
                                {% csrf_token %}
                                <select name="new_group_id" style="font-size: 0.8em; padding: 5px; width:100%;">
                                    <option value="" disabled selected>Move...</option>
                                    {% for g in group_data %}
                                        {% if g.group.id != item.group.id %}
                                            <option value="{{ g.group.id }}">{{ g.group.name }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <button type="submit" class="btn-go">Go</button>
                            </form>
                        </div>
                        {% empty %}
                        <p style="color:#666; font-style:italic;">Empty Group</p>
                        {% endfor %}
                    </div>

                    <div style="margin-top: 15px; border-top: 1px dashed #444; padding-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 0.9em; color: #aaa;">Total Group Power:</span>
                        <span style="font-size: 1.2em; font-weight: bold; color: #ff9800;">
                            {{ item.skill_values.0|add:item.skill_values.1|add:item.skill_values.2|add:item.skill_values.3 }} pts
                        </span>
                    </div>

                    <script>
                        (function() {
                            var ctx = document.getElementById('chart-{{ item.group.id }}');
                            var skillsData = JSON.parse(ctx.getAttribute('data-skills'));
                            
                            // Dark Theme Chart Config
                            new Chart(ctx, {
                                type: 'radar',
                                data: {
                                    labels: ['Code', 'Design', 'Write', 'Speak'],
                                    datasets: [{
                                        data: skillsData, 
                                        fill: true, 
                                        backgroundColor: 'rgba(255, 152, 0, 0.2)', 
                                        borderColor: '#ff9800', 
                                        pointBackgroundColor: '#ff9800',
                                        pointRadius: 3,
                                    }]
                                },
                                options: {
                                    scales: { 
                                        r: { 
                                            suggestedMin: 0, 
                                            suggestedMax: 20, 
                                            ticks: { display: false, backdropColor: 'transparent' },
                                            grid: { color: '#444' }, 
                                            angleLines: { color: '#444' },
                                            pointLabels: { color: '#aaa', font: {size: 10} } 
                                        } 
                                    }, 
                                    plugins: { legend: { display: false } }
                                }
                            });
                        })();
                    </script>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <a href="{% url 'section_list' %}" class="btn-back">‚Üê Back to Classes</a>

</body>
</html>